# Import required libraries
from itertools import zip_longest
import streamlit as st
from langchain_community.document_loaders import PyPDFLoader
from streamlit_chat import message
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import FAISS
from langchain.schema import (
    SystemMessage,
    HumanMessage,
    AIMessage
)
import os
from langchain_community.document_loaders import PyPDFLoader
from langchain_community.vectorstores import FAISS
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_openai import OpenAIEmbeddings
from langchain.chains import create_history_aware_retriever
from langchain_core.prompts import MessagesPlaceholder
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain.chains import create_retrieval_chain
from langchain_community.document_loaders import WebBaseLoader
from langchain_core.documents import Document

#Load environment variables
# Set streamlit page configuration
st.set_page_config(page_title="AI-Kurs ChatBot")
st.title("AI-Kurs ChatBot")

# Initialize session state variables
if 'generated' not in st.session_state:
    st.session_state['generated'] = []  # Store AI generated responses

if 'past' not in st.session_state:
    st.session_state['past'] = []  # Store past user inputs

if 'entered_prompt' not in st.session_state:
    st.session_state['entered_prompt'] = ""  # Store the latest user input

# Initialize the ChatOpenAI model
chat = ChatOpenAI(
    temperature=0.1,
    model_name="gpt-4-turbo",
    api_key=st.secrets['openai_api_key']
)
# Intialize embeddings
embeddings = OpenAIEmbeddings(openai_api_key=st.secrets['openai_api_key'])

#Fetch and load documents
#path = "app/static/CV.pdf"
#loader = PyPDFLoader(path)
#docs = loader.load()

#Indexing
text_splitter = RecursiveCharacterTextSplitter()
#documents = text_splitter.split_documents(docs)
documents = [Document(page_content='Generelle vilk√•r    1/13  \n \nInnhold  \n1. Varighet for forsikringsavtalen og beregning av premie  ................................ ................................ ................................ ...........  3 \n2. Fornyelse av fo rsikringen  ................................ ................................ ................................ ................................ ................................ ............  3 \n3. Oppsigelse i forsikringstiden ‚Äì Sikrede  ................................ ................................ ................................ ................................ ..............  3 \n4. Oppsigelse i forsikringstiden ‚Äì If ................................ ................................ ................................ ................................ ............................  4 \n5. Skj√∏nn  ................................ ................................ ................................ ................................ ................................ ................................ .....................  5 \n6. Renter av erstatningsbel√∏p  ................................ ................................ ................................ ................................ ................................ ....... 5 \n7. Merverdiavgift  ................................ ................................ ................................ ................................ ................................ ................................ ... 5 \n8. Mangelfull/fe ilaktig utf√∏rt reparasjon  ................................ ................................ ................................ ................................ .................  5 \n9. F√∏lgene av svik  ................................ ................................ ................................ ................................ ................................ ................................ .. 6 \n10. Identifikasjon  ................................ ................................ ................................ ................................ ................................ ................................ ... 6 \n11. Ulovlige interesser  ................................ ................................ ................................ ................................ ................................ .........................  6 \n12. Ikke d eklarerte gjenstander  ................................ ................................ ................................ ................................ ................................ .... 6 \n13. Vinningsforbud  ................................ ................................ ................................ ................................ ................................ ...............................  6 \n14. Lovvalg  ................................ ................................ ................................ ................................ ................................ ................................ .................  6 \n15. Valuta  ................................ ................................ ................................ ................................ ................................ ................................ ...................  6 \n16. Garantiordning for skadeforsikring  ................................ ................................ ................................ ................................ ....................  7 \n17. S√¶rlige begrensninger i Ifs erstatningsplikt  ................................ ................................ ................................ ................................ ... 7 \n18. Verneting  ................................ ................................ ................................ ................................ ................................ ................................ ...........  9', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 0}), Document(page_content='19. Personopplysninger  ................................ ................................ ................................ ................................ ................................ .....................  9 Generelle vilk√•r  \nForsikringsvilk√•r GEN 2-9 \nGjelder fra 10. juni  2023', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 0}), Document(page_content='Generelle vilk√•r    2/13  20. Trafikkforsikringsavgift til staten  ................................ ................................ ................................ ................................ ........................  9 \n21. EUs klageportal  ................................ ................................ ................................ ................................ ................................ ...............................  9 \n22. Rettshjelp - generelle bestemmelser  ................................ ................................ ................................ ................................ ...............  10', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 1}), Document(page_content='Generelle vilk√•r    3/13  Disse vilk√•r gjelder i den utstrekning de ikke er fraveket i de enkelte bransjevilk√•r eller i forsikringsbeviset.  \n1. Varighet for forsikringsavtalen og beregning av premie  \nForsikringen gjelder fra det tidspunkt avtale er vedtatt av partene eller fra og med en senere avtalt dato kl. \n00.00. Forsikringen gjelder til kl. 24.00 siste dato i avtaleperioden. Tilsvarende gjelder for senere \nfornyelser.  \nHvis det er en forutsetning at premien skal v√¶re betalt f√∏r Ifs ansvar begynner √• l√∏pe, kommer  dette frem \nav forsikringsbeviset for den enkelte dekning.  \nOpph√∏rer en l√∏pende forsikring i avtaleperioden, har If krav p√• premie forholdsmessig etter den tiden \nforsikringen har v√¶rt i kraft, med mindre noe annet kommer frem  av det enkelte fo rsikringsvilk√•r.  \nVed terminvis premiebetaling vil det kunne bli beregnet et termintillegg.  \n2. Fornyelse av forsikringen  \nForsikring som gjelder for en tid av minst ett √•r, fornyes for ett √•r a v gangen, hvis ikke forsikringstakeren \nhar sagt opp avtalen innen fo rsikringstidens utl√∏p.  \n3. Oppsigelse i forsikringstiden ‚Äì Sikrede   \n3.1. Sikrede kan si opp  \n3.1.1. Livsforsikring  \n‚Ä¢ N√•r som helst i forsikrings√•ret.  \nDette punkt kan v√¶re fraveket i avtaler om kollektiv forsikring og vil i s√• fall komme frem  av \nforsikringsbeviset.  \n3.1.2. Annen personforsikring  \n‚Ä¢ N√•r som helst med 1 m√•neds varsel,  jf. lov 16. juni 1989 nr. 69 om forsikringsavtaler  \n(forsikringsavtaleloven ‚Äì FAL ) ¬ß 12-3, 3. ledd dersom behovet faller bort eller ved andre s√¶rlige \ngrunner kan forsikringen sies opp umiddelbart. Dette punkt kan v√¶re fraveket i avtaler om kollektiv \nforsikring og vil i s√• fall komme frem  av forsikringsbeviset.  \n3.1.3. Skadeforsikring  \n‚Ä¢ Dersom for sikringsbehovet faller bort eller det foreligger andre s√¶rlige grunner, jf. F AL ¬ß 3-6, 1.ledd.  \n‚Ä¢ For flytting til et annet forsikringsselskap med 1 m√•neds varsel. Varselet skal inneholde opplysning om \ndato for flyttingen og til hvilket selskap den skal flyt tes til, jf. FAL ¬ß 3 -6, 2. ledd, 2. punktum.  \nFor at oppsigelsen skal komme inn under reglene om flytting, skal den nye forsikringen ha minst samme \neller tiln√¶rmet samme dekningsomfang.  \nFor kollektive forsikringsavtaler og forsikringsavtaler for virksomhet er som kommer inn under FAL ¬ß 1 -3 \npunkt a til e, kan retten til flytting fravikes. Dette vil i s√• fall komme frem  av forsikringsbeviset.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 2}), Document(page_content='Generelle vilk√•r    4/13  4. Oppsigelse i forsikringstiden  ‚Äì If \nFor If er oppsigelsestiden 2 m√•neder f√∏r utl√∏pet av forsikringstiden. Forsikringsvilk√•r og premie kan \nendres og blir gjeldende fra fornyelsesdag.  \n4.1. If kan si opp forsikringen  \n4.1.1. Med √∏yeblikkelig virkning  \nHvis det foreligger svik i forbindelse m ed opplysninger om risikoen, jf. FAL ¬ß 4 -3 eller ¬ß 13 -3. \n4.1.2. Med en ukes varsel  \nHvis det foreligger svik ved skadeoppgj√∏ret, jf. FAL ¬ß 8 -1 eller ¬ß18 -1. \n4.1.3. Med 14 dagers varsel  \nHvis det er gitt uriktige eller ufullstendige opplysninger om risikoen, jf. FAL ¬ß 4 -3 eller ¬ß 13 -3. \n4.1.4. Med to m√•neders varsel  \nJf. FAL ¬ß 3 -7 eller ¬ß 12 -4 hvis d et er rimelig og  \n‚Ä¢ forsikringstaker/sikrede/forsikrede har fremkalt - eller har medvirket til √• fremkalle - skade forsettlig, \neller  \n‚Ä¢ sikrede har fors√∏mt √• overholde en sikkerhetsforskrift, eller  \n‚Ä¢ skadeforl√∏pet viser stort avvik fra det normale, eller  \n‚Ä¢ det i l√∏pet av de siste 12 m√•neder har v√¶rt minst 3 skader tilsammen under denne og andre avtaler \nmed If , eller  \n‚Ä¢ forsikringstaker/sikrede/forsikrede har medvirket til svik mot If i henhold til FAL ¬ß 4 -3 eller ¬ß 13 -2 eller \n¬ß 8-1/18 -1, eller  \n‚Ä¢ forsikringstaker gjentatte ganger har misligholdt betalingsfristene , eller  \n‚Ä¢ forsikringstaker/sikrede/forsikrede eller noen som kan identifiseres med disse, har fremsatt trusler \nmot ansatte i If , eller  \n‚Ä¢ forsikringstaker/sikrede/ forsikrede har beg√•tt et straffbart forhold mot If, eller  \n‚Ä¢ If ikke f√•r gjennomf√∏rt l√∏pende oppf√∏lging av kundeforholdet i samsvar med pliktene som f√∏lger av \nhvitvaskingsloven.  \n4.1.5. Med 2 m√•neders frist  \nJf. FAL ¬ß. 3 -7 eller ¬ß 12 -4 der bruken av forsikringsgjenstanden eller sikredes virksomhet endres  i \nforsikri ngstiden p√• en m√•te som:  \n‚Ä¢ Inneb√¶rer at If ikke ville ha overtatt forsikringen om det nye forholdet hadde foreligget ved \nforsikringstidens begynnelse, eller  \n‚Ä¢ Er av betydning for Selskapets mulighet til √• gjenforsikre.  \n4.2. Ved manglende betaling  \nDers om forsikringen opph√∏rer p√• grunn av manglende betaling har If krav p√• premie for den tid det har \nv√¶rt i ansvar etter bestemmelsene i FAL kapittel 5 og/eller kapittel 14.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 3}), Document(page_content='Generelle vilk√•r    5/13  If har ogs√• krav p√• et tillegg for f√∏lgende omkostninger:  \nPoliseutstedelseskostnad innti l 300 kroner per avtale, og panthaverinteresse inntil 300 kroner per \nforsikringsobjekt, dog 600 kroner for fritidsb√•t.  \n5. Skj√∏nn  \nEr det adgang til √• kreve skj√∏nn i henhold til forsikringsvilk√•rene, gjelder f√∏lgende bestemmelser om \nfremgangsm√•ten:  \nSkj√∏nn kan kreves n√•r som helst under skadeoppgj√∏ret.  \nSkj√∏nn avgis av sakkyndige og uhildede personer. Hver av partene velger en skj√∏nnsmann. Hvis noen av \npartene √∏nsker det, kan han eller hun velge s√¶rskilt skj√∏nnsmann for bestemte ting og ved avbruddstap \nfor bestem te sp√∏rsm√•l.  \nHar den ene av partene skriftlig underrettet den annen om sitt valg, plikter denne innen en uke etter at \nhan eller hun har mottatt underretningen √• gi meddelelse om hvem han eller hun velger. F√∏r skj√∏nnet \nvelger de to skj√∏nnsmenn en oppmann.  \nHvis noen av partene forlanger det, skal denne v√¶re bosatt utenfor partenes hjemsted og utenfor den \nkommune hvor forsikringstilfellet er inntruffet. Unnlater en av partene √• velge skj√∏nnsmann, oppnevnes \ndenne p√• hans eller hennes vegne av tingretten i den rettskrets hvor skj√∏nnet foretas. Blir \nskj√∏nnsmennene ikke enige om oppmann, oppnevnes denne p√• samme m√•te.  \nSkj√∏nnsmennene plikter √• innhente de opplysninger og foreta de unders√∏kelser som de anser n√∏dvendige. \nDe plikter √• avgi sitt skj√∏nn p√• grunnlag av f orsikringsvilk√•rene. De to skj√∏nnsmenn foretar verdsettelsen \nog besvarer sp√∏rsm√•lene ved avbruddstap, uten at oppmannen tilkalles. Blir de ikke enige, tilkalles \noppmannen, som etter de samme regler avgir sitt skj√∏nn over de punkter som skj√∏nnsmennene er ue nige \nom. Blir oppmannen tilkalt, beregnes erstatningen p√• grunnlag av dennes skj√∏nn. Erstatning skal dog ikke \nligge utenfor de grenser som de to skj√∏nnsmenns ansettelser vil medf√∏re.  \nPartene betaler hver sin skj√∏nnsmann. Honorar til oppmannen og mulige an dre omkostninger ved skj√∏nnet \nb√¶res av partene med en halvdel hver. Er det Selskapet som krever skj√∏nn ved tingskade, og  den annen \npart er forsikringstaker i egenskap av privatperson,  dekker Selskapet likevel alle omkostninger ved - \nskj√∏nnet hvis forsikring stakeren ikke selv √∏nsker √• b√¶re sin del. Skj√∏nnets verdsettelser er bindende for \nbegge parter.  \n6. Renter av erstatningsbel√∏p  \nSikrede har krav p√• renter overensstemmende med reglene i FAL ¬ß 8-4 eller ¬ß 18 -4. \n7. Merverdiavgift  \nIf erstatter ikke merverdiavgift som sikrede har fradragsrett for i sin n√¶ringsvirksomhet.  \n8. Mangelfull/feilaktig utf√∏rt reparasjon  \nIf svarer ikke for mangelfull/feilaktig utf√∏rt reparasjon, eller f√∏lgeskader etter slik reparasjon, med mindre \nde nye skadene er dekningsmessige  i henhold til forsikringens vilk√•r.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 4}), Document(page_content='Generelle vilk√•r    6/13  9. F√∏lgene av svik  \nDen som gj√∏r seg skyldig i svik mot If, mister ethvert erstatningskrav mot If etter denne og andre \nforsikringsavtaler i anledning samme hendelse. Allerede utbetalte erstatningsbel√∏p kan kreves \ntilbakebet alt. If kan si opp enhver forsikringsavtale med sikrede, jf. FAL ¬ß ¬ß 4-2, 4-3 og 8-1 eller ¬ß 13 -2, 13 -3 \nog 18 -1, jf. ogs√• punkt 4.1 og 10. \nIf kan ogs√• si opp enhver forsikringsavtale med den som medvirker til svik, jf. ogs√• punkt 4.1.4 ovenfor.  \n10. Identifikasjon  \nBestemmelser om at sikredes rett til erstatning helt eller delvis bortfaller som f√∏lge av sikredes handlinger \neller unnlatelser f√•r tilsvarende anvendelse ved handlinger eller unnlatelser fra personer som nevnt i FAL \n¬ß 4-11, annet ledd.  \nFor n√¶ringsforsikring gjelder i tillegg f√∏lgende:  \nDe handlinger eller unnlatelser som medf√∏rer bortfall eller reduksjon av sikredes rett til erstatning \nmedf√∏rer tilsvarende bortfall eller reduksjon dersom de er beg√•tt av personer som utf√∏rer arbeid av \nledende art eller av andre som har selvstendig stilling innen virksomheten. Med personer som har s√¶rlig \nselvstendig stilling menes ogs√• personer som utf√∏rer arbeidsoppdrag uten overoppsyn fra andre, eller som \nutf√∏rer arbeidsoppdrag de selv er ansvarlige for. Sikre de identifiseres tilsvarende med sine \nkontraktsmedhjelperes handlinger eller unnlatelser.  \n11. Ulovlige interesser  \nForsikringen omfatter kun lovlige interesser som kan verdsettes i penger.  \n12. Ikke deklarerte gjenstander  \nForsikringen omfatter ikke erstatning for gj enstander som er kj√∏pt, eller mottatt som gave, utenfor Norge \nog som ikke er deklarert ved innf√∏rsel i henhold til gjeldende regelverk. Se lov 21. desember 2007 nr. 119 \nom toll og varef√∏rsel (tolloven) og lov 19. juni 2009 nr. 58 om merverdiavgift (merverd iavgiftsloven) med \nforskrifter.  \n13. Vinningsforbud  \nForsikringen skal ikke f√∏re til vinning, men skal bare erstatte det tap som virkelig er lidt innenfor rammen \nav forsikringsavtalen. Forsikringssummen er intet bevis for tingens eller interessens verdi.  \n14. Lovvalg  \nNorsk lovgivning gjelder for forsikringsavtalen i den utstrekning dette ikke er i strid med lov 27. november \n1992 nr. 111 om lovvalg i forsikring (forsikringslovvalgsloven) , eller det er gjort annen avtale.  \n15. Valuta  \nPremiebel√∏p, forsikringssummer, erstatningsbel√∏p med videre som springer ut av forsikringsavtalen, \nregnes i norske kroner (NOK) dersom ikke annet kommer frem  av vilk√•r eller forsikringsbevis.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 5}), Document(page_content='Generelle vilk√•r    7/13  16. Garantiordning for skadeforsikring  \nIf er medlem av garantiordningen for skadeforsikring, se lov av 10. april 2015 nr. 17 kap. 2 0A om \nfinansforetak og finanskonsern (finansforetaksloven) . Ordningen skal v√¶re en trygghet for sikrede dersom \nIf blir insolvent og  ikke kan betale det de plikter i  henhold til inng√•tte skadeforsikringsavtaler.  \nGarantiordningen dekker opptil 90 % av hvert enkelt krav. Krav etter forsikringer som gjelder bolig og \ntvungen ansvarsforsikring skal likevel dekkes med 100 %. Garantiordningen dekker ikke forsikringskrav \nutov er 20 millioner kroner for hvert krav for hver sikret for hvert skadetilfelle.  Garantiordningen dekker \nkun krav vedr√∏rende risikoer som best√•r her i riket, jf. finansforetaksforskriften ¬ß 20A -1 annet ledd.  \nGarantiordningen dekker blant annet ikke kredittfo rsikring, livsforsikringer, energiforsikringer og \nluftfartsforsikringer. Videre dekkes ikke sj√∏forsikring, unntatt n√•r forsikringen gjelder skip som ikke er \nregistreringspliktige i henhold til lov 24. juni 1994 nr. 39 om sj√∏farten (sj√∏loven)  ¬ß 11 annet led d, eller \nfiskefart√∏yer opp til og med 50 bruttotonn som er registrert i Skipsregisteret, jf. sj√∏loven ¬ß 11 f√∏rste ledd \nf√∏rste punktum.  \nGarantiordningen dekker ikke n√¶ringslivsforsikringer, n√•r forsikringen gjelder foretak som ved \navtaleinng√•elsen eller sen ere fornyelser oppfyller minst to av f√∏lgende vilk√•r : \n‚Ä¢ Har flere enn 250 ansatte  \n‚Ä¢ har en omsetning p√• minst 100 millioner kroner if√∏lge siste √•rsoppgj√∏r  \n‚Ä¢ har eiendeler if√∏lge siste balanse p√• minst 50 millioner kroner.  \nGarantiordningen dekker likevel ansvars forsikringer som er p√•lagt etter norsk lov (tvungen \nansvarsforsikring).  \nFor n√¶rmere detaljer henvises det til finansforetaksloven kap. 20A .  \n17. S√¶rlige begrensninger i Ifs erstatningsplikt  \n17.1. Kjernefysisk, biologisk, kjemisk og radioakti v skade√•rsak  \nIf svarer ik ke for tap eller skade, og √∏kning i tap eller skade, som direkte eller indirekte er for√•rsaket av \neller st√•r i sammenheng med  \n‚Ä¢ ioniserende str√•ling eller radioaktiv forurensning fra kjernefysisk brensel eller atomavfall fra \nforbrenning av kjernefysisk brensel,  \n‚Ä¢ radioaktive, giftige, eksplosive eller andre farlige egenskaper ved enhver eksplosiv kjernefysisk enhet \neller kjernefysiske komponenter i disse,  \n‚Ä¢ ethvert v√•pen eller annen anordning der det benyttes atomspalting, kjernespalting og/elle r \nkjernefysisk fusjon eller atomfusjon, eller andre lignende reaksjoner eller radioaktiv kraft eller \nradioaktivt materiale,  \n‚Ä¢ radioaktive, giftige, eksplosive eller andre farlige eller forurensende egenskaper ved radioaktivt \nmateriale. Unntaket i dette kule punktet  omfatter ikke radioaktive isotoper, annet enn kjernefysisk \nbrensel, n√•r disse isotopene blir fremstilt, transportert, lagret eller brukt til kommersielle, \nlandbruksrelaterte, medisinske eller vitenskapelige form√•l eller andre lignende fredelige form √•l, eller  \n‚Ä¢ kjemiske, biologiske, biokjemiske eller elektromagnetiske v√•pen . \nPunktene ovenfor gjelder uavhengig av enhver annen √•rsak eller hendelse som bidrar samtidig eller i \nrekkef√∏lge til skaden.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 6}), Document(page_content='Generelle vilk√•r    8/13  17.2. Krig , streik, oppt√∏yer og sivile uroligheter  \nIf svarer ikk e for tap eller skade, og/eller √∏kning i tap eller skade, som direkte eller indirekte er for√•rsaket \nav eller st√•r i sammenheng med krig, invasjon, handlinger fra en fremmed fiendtlig makt, fiendtligheter \neller krigslignende operasjoner (uavhengig av om det  er erkl√¶rt krig eller ikke), borgerkrig, mytteri, \noppr√∏r, streik, oppt√∏yer, sivile uroligheter av et omfang som tilsvarer en folkelig eller milit√¶r makt, \nrevolusjon, oppr√∏r eller milit√¶r eller annen tilraning av makten. Alt dette uavhengig av enhver annen  √•rsak \neller hendelse som bidrar samtidig eller i rekkef√∏lge til skaden.  \n17.3. Terror  \nFor forsikringer av bygninger, maskiner, l√∏s√∏re, varer og driftstap knyttet til n√¶ringsvirksomhet, offentlig \nvirksomhet og bygninger/husleietap tilh√∏rende borettslag/boligsameie er erstatningsplikten begrenset til \nEUR 50 000 000 per hendelse, dersom den erstatningsmessige skade er for√•rsaket av eller st√•r i \nsammenheng med en terrorhandling. For slike forsikrede ting og interesser som befinner seg utenfor \nNorden, Estland, Latvia eller Litauen, erstattes ikke skader som er for√•rsaket av eller st√•r i sammenheng \nmed terrorhandling.  \nMed terrorhandling forst√•s en rettsstridig, skadevoldende handling rettet mot allmennheten, herunder en \nvoldshandling eller farlig sp redning av biologiske eller kjemiske substanser - og som fremst√•r √• v√¶re utf√∏rt \ni den hensikt √• ut√∏ve innflytelse p√• politiske, religi√∏se eller andre ideologiske organer eller for √• fremkalle \nfrykt. Med hendelse forst√•s alle skader som rammer If og dets mo rselskap med √∏vrige filialers \nforsikringstakere i Norden, Estland, Latvia eller Litauen innenfor et tidsrom av 48 timer. Overstiges den \nfastsatte grense pr hendelse, m√• sikrede t√•le en forholdsmessig reduksjon av erstatningsbel√∏pet.  \nSkader for√•rsaket av el ler som st√•r i sammenheng med terror ved bruk av, eller trusler om bruk av \natomv√•pen eller farlig spredning av biologiske eller kjemiske substanser er uansett ikke dekket.  \nDenne begrensning gjelder i den utstrekning det ikke uttrykkelig er presisert i fors ikringsbeviset eller i \npersonforsikrings eller reiseforsikrings bransjevilk√•r, at den er fraveket helt eller delvis.  \n17.4. Jordskjelv og vulkanske utbrudd  \nIf svarer ikke for tap eller skade, og √∏kning i tap eller skade, som direkte eller indirekte er for√•rsaket av \neller st√•r i sammenheng med jordskjelv og vulkanske utbrudd.  \nDenne begrensning gjelder i den utstrekning det ikke uttrykkelig er presisert i bransjevilk√•ret at den er \nfraveket.  \n17.5. Brudd p√• internasjonal lovgivning, sanksjoner  \nIf kan ikke gi tilsagn om dekn ing eller betale ut erstatning eller andre ytelser dersom dette kan medf√∏re at \nIf handler i strid med, eller utsetter If for forbud, restriksjoner eller sanksjoner vedtatt i De Forente \nNasjoners organer. Det samme gjelder handels - eller √∏konomiske sanksj oner, nedfelt i lover eller direktiver \nvedtatt av EU, USA eller Norge.  \n17.6. Unntak som gjelder Russland -relaterte risikoer  \nForsikringen dekker ikke  \n‚Ä¢ transport av varer til, fra, innen eller gjennom Den russiske f√∏derasjon, Belarus, Donetsk, Luhansk, \nKrim -territor iet eller  Den russiske f√∏derasjons territorialfarvann.  \n‚Ä¢ skader eller erstatningskrav i forbindelse med transport av varer til, fra, innen eller gjennom Den \nrussiske f√∏derasjon, Belarus, Donetsk, Luhansk, Krim -territoriet eller Den russiske f√∏derasjons \nterritorialfarvann.  \n‚Ä¢ eiendom, eller skade p√• eiendom, uanset t art, som direkte eller indirekte er kj√∏pt eller importert fra \nDen russiske f√∏derasjon  etter 31. desember 2022 .', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 7}), Document(page_content='Generelle vilk√•r    9/13  18. Verneting  \nTvister etter forsikringsavtalen avgj√∏res ved norsk domstol, med mindre det er i strid med ufravikelige \nregler i gjeldende lovgivning , eller det er gjort annen avtale.  \n19. Personopplysninger  \nIf behandler personop plysninger i overensstemmelse med gjeldende lovgivning om forsikring og \ndatabeskyttelse. Les mer om behandling av personopplysninger p√• v√•r hjemmeside: \nhttp://www.if.no/personopplys ninger.   \n20. Trafikkforsikringsavgift til staten  \nIf krever inn trafikkforsikringsavgift til staten og avgiften m√• betales for alle registrerte kj√∏ret√∏y under 7 \n500 kg. Betaling av avgift er en forutsetning for forsikringsavtalen . Dersom avgift ikke betales for slikt \nforsikret kj√∏ret√∏y , f√•r dette samme virkning for forsikringene under samme forsikringsavtale som \nmanglende betaling av forsikringspremie.  \n21. EUs klageportal  \nEUs klageportal kan benyttes i saker som gjelder kj√∏p av tjeneste r og varer p√• nett. (Klageportalen er \nopprettet prim√¶rt for grenseoverskridende saker der partene er i ulike land, men utelukker ikke at \nnasjonale saker kan inngis). Lenke til portalen finner du p√• v√•re hjemmesider www.if.n o under overskriften \n¬´Klagemuligheter¬ª. I klageportalens skjema blir du bedt om √• fylle inn Ifs e -postadresse, bruk da: \nkundeombudet@if.no . \n22. Generelle fravikelser fra FAL for store risikoer \n(Forsikringsavtaleforskri ften)  og andre enn forbrukere (FAL \n¬ß 1-2a) \n22.1. Kommunikasjon ‚Äì FAL ¬ß1 -6 \nF√∏lgende fravikelser er avtalt for ¬´store risikoer¬ª og andre enn forbrukere:  \nEn elektronisk melding fra foretaket skal anses mottatt og ha kommet til mottakers kunnskap p√• det \ntidspunkt meldingen er sendt til mottakers avtalte kommunikasjonsplattform. ¬ß 1 -6 annet og tredje ledd er \nmed dette fraveket.  \nFor ¬´store risikoer¬ª er i tillegg f√∏lgende fravikelser avtalt:  \nAll kommunikasjon mellom partene kan foreg√• ved elektronisk kommuni kasjon. Kunden kan ikke reservere \nseg mot denne kommunikasjonsformen. Kommunikasjonen foreg√•r gjennom avtalte \nkommunikasjonsplattformer. ¬ß 1 -6 f√∏rste ledd er fraveket. N√•r det etter forsikringsavtaleloven stilles krav \nom at noen skal varsles, er lovens kra v oppfylt ved at varselet avsendes til avtalt \nkommunikasjonsplattform. ¬ß 1 -6 fjerde ledd er fraveket. Med skriftlig dokument menes papir eller enhver \nelektronisk kommunikasjon som er sendt til mottakers avtalte kommunikasjonsplattform. ¬ß 1 -6 femte ledd \ner fraveket.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 8}), Document(page_content='Generelle vilk√•r    10/13  22.2. Prekontraktuelle plikter ‚Äì FALs annen del  \nF√∏lgende fravikelser er avtalt for ¬´store risikoer¬ª og andre enn forbrukere:  \n¬ß 1C -3 er fraveket, ved at foretaket ikke plikter √• gi standardisert informasjonsdokument til kunden.  \nFor ¬´store risikoer¬ª er i  tillegg f√∏lgende fravikelser avtalt:  \nLovens annen del gjelder ikke for forsikringsdistribusjon knyttet til avtale om store risikoer. ¬ß1A -1 f√∏rste og \nannet ledd er fraveket.  \n¬ß 1B -1 er fraveket ved at kunden identifiserer sine krav og behov f√∏r inng√•else av  forsikringsavtalen, og \ns√∏rger for at disse oppfylles gjennom  avtalen. Dette gjelder videre i forhold til alle √∏vrige prekontraktuelle \nplikter i ¬ß1B -1, ogs√• i forhold til alternative dekningsformer og aktuelle  tilleggsdekninger, og gjelder b√•de \nved skade - og personforsikring. Det er ikke krav om bruk av skriftlig dokument, verken knyttet til \nanbefalinger eller ved fremsettelse av tilbud. Forsikringsdistribut√∏r kan kreve vederlag for oppfyllelse av \nopplysnings - eller varslingsplikter etter forsikringsavtalel oven.  \nKapittel 1C er fraveket i sin helhet. Kundens informasjonsbehov anses avdekket og oppfylt fortl√∏pende og i \nn√∏dvendig utstrekning i de l√∏pende forhandlinger og i kommunikasjonen mellom forsikringsdistribut√∏ren \nog kunden forut for avtaleinng√•elsen. Kun den har det endelige ansvaret for √• ettersp√∏rre informasjon \nkunden mener er relevant f√∏r avtaleinng√•elsen.  \n22.3. Bevisbyrde (¬ß 21 -1) /erstatning for pliktbrudd (  ¬ß 21 -2)/klageregler (¬ß \n22-1) \nF√∏lgende fravikelser er avtalt for ¬´store risikoer¬ª og andre enn forbr ukere:  \nDet er alminnelige bevisbyrderegler som gjelder for sp√∏rsm√•let om forsikringsforetaket har oppfylt sine \nplikter etter lov og forskrift. ¬ß 21 -1 er fraveket.  \nForsikringsforetakets erstatningsplikt er begrenset til den positive kontraktsinteresse, dvs . den \nforsikringsutbetaling kunden hadde hatt krav p√• hvis forsikringsforetaket hadde oppfylt sine plikter etter \n¬ß 1-5 f√∏rste ledd. ¬ß 21 -2 er fraveket.  \nKlager og krav som gjelder brudd p√• ¬ß 1 -5 f√∏rste ledd, besvares av forsikringsforetaket innenfor rammen \nav foretakets alminnelige saksbehandlingstid. Det gjelder ingen formkrav eller s√¶rskilte frister for \nbesvarelsen. ¬ß 22 -1 tredje ledd er fraveket.  \n23. Rettshjelp - generelle bestemmelser  \nN√•r det av bransjevilk√•ret kommer frem at rettshjelp er omfattet av forsikringsavtalen og det er henvist til \ndette punkt et, gjelder disse generelle bestemmelser.  \n23.1. Hva forst√•s med "tvist"  \nMed tvist forst√•s at et krav er fremsatt og bestridt, helt eller delvis. Vedvarende taushet hos motpart vil \nkunne anses som tvist. Det kan  v√¶re √©n tvist selv om saken best√•r av flere sp√∏rsm√•l og de faktiske og \nrettslige tvistegrunnlag er ulike. Det er √©n tvist selv som sp√∏rsm√•lene fremmes i flere saker. Det samme \ngjelder selv om det er flere parter p√• samme side, og ogs√• om partene har forsk jellige forsikringsavtaler i \nforskjellige forsikringsselskap.  \n23.2. Hva If dekker  \nForsikringen dekker utgifter - saksomkostninger -ved tvist oppst√•tt i forsikringstiden, og hvor tvisten \nh√∏rer inn under de alminnelige domstoler, jf.  lov 13. august 1915 nr. 5 om d omstolene ( domstolloven ) ¬ß 1. \nUtgifter til sakkyndige som ikke er oppnevnt av retten, dekkes bare n√•r utgiftene p√• forh√•nd er godkjent \nav If. Utgifter til vitner dekkes bare ved hovedforhandling og bevisopptak. Id√∏mte saksomkostninger \ndekkes ikke. Saksomko stninger som dekkes av motpart, g√•r til fradrag. Likevel dekkes slike \nsaksomkostninger n√•r sikrede kan godtgj√∏re at motparten ikke er s√∏kegod.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 9}), Document(page_content='Generelle vilk√•r    11/13  23.3. Forsikringssum  \nDen samlede erstatning ved hver tvist er begrenset til 100  000 kroner. I de tilfeller det er tre eller flere \nparter p√• sikredes side og de faktiske og juridiske problemstillinger i det alt vesentlige er de samme er den \nsamlede forsikringssummen begrenset t il 250  000 kroner.  \nI saker mot selger av bolig og/eller selgers boligselgerforsikringsselskap er timesatsen som dekkes \nbegrenset til gjeldende offentlige sal√¶rsatser med tillegg av 200 kroner, jf. forskrift 3. desember 1997 nr. \n1441 om sal√¶r fra det offen tlige til advokater m.v. ( sal√¶rforskriften ) ¬ß 2. If svarer ikke for evt. kostnader \nsom oppst√•r ved bytte av advokat.  \nAnnen forsikringssum kan v√¶re angitt i bransjevilk√•ret og gjelder da foran ovennevnte forsikringssummer.  \n23.4. Egenandel  \nEgenandel 4  000 kroner m ed tillegg av 20% av det overskytende. Det trekkes bare en egenandel for hver \ntvist selv om det er flere parter p√• samme side. Annen egenandel kan v√¶re angitt i bransjevilk√•ret og \ngjelder da foran ovennevnte egenandel.  \n23.5. Utgifter If ikke dekker  \nIf dekker ikk e utgifter ved:  \n1: Tvist dersom tvistegrunnlaget forel√• ved forsikringens ikrafttreden.  \n2: Tvist som har sammenheng med eller sitt utspring i separasjon, skilsmisse, barnefordeling, \nsamv√¶rsrett, farskap, arv, krav om omst√∏telse av gave, underholdsbidrag, bodelin g, √∏konomisk \nfellesskap etablert av samboende og oppl√∏sning av husstandsfellesskap samt skiftesaker.  \n3: Tvist som har sammenheng med eller sitt utspring i sikredes yrke eller erverv herunder oppgj√∏r etter \nyrkesskadeforsikringsloven.  \nVed tvist om erstatning et ter lov 16. juni 1989 nr. 65 om yrkesskadeforsikring \n(yrkesskadeforsikringsloven)  dekkes likevel utgifter p√•l√∏pt etter at sak er anlagt for de alminnelige \ndomstoler. Med erverv forst√•s enhver virksomhet som har som form√•l √• tjene penger.  \n4: Tvist som alene gj elder tvangsfullbyrdelse.  \n5: Tvist som gjelder gjeldsforhandling/gjeldsordningssak og sak som gjelder konkurs - eller \nakkordforhandling dersom sikrede er konkurs - eller akkordskyldner.  \n6: Ved tvist som gjelder eller som har sitt utspring i straffbar handling, √¶re krenkelsessak, \nf√∏rerkortbeslag eller erstatningskrav i slike saker n√•r sikrede er part, mistenkt, siktet eller tiltalt. \nLikevel dekkes utgifter dersom sikrede er forn√¶rmet/skadelidt i anledning straffbar handling.  \n7: Tvist som gjelder offentlig forvaltningsve dtak. Likevel dekkes utgifter ved s√∏ksm√•l n√•r den \nadministrative klagemulighet er fullt utnyttet. I tilknytning til s√∏ksm√•l er enhver utgift p√•dratt under \nforvaltningsbehandlingen unntatt fra dekning. Utlendingssaker vil i sin helhet v√¶re unntatt fra \ndekni ngen.  \n8: Tvist om advokatsal√¶r eller tvist om utgifter til sakkyndige.  \n9: Tvist som gjelder finansielle spareprodukter med investering over 1 000  000 kroner, og handel med \nfinansielle instrumenter.  \n10: Tvist som gjelder utleiebolig som skal regnskap slignes, n√•r utgi ften er fradragsberettiget (skatteloven \n¬ß6).  \n11: Tvist som √•penbart ikke kan vinne frem.  \n12: Tvist som gjelder Ifs avslag p√• dekning av rettshjelpsforsikring.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 10}), Document(page_content='Generelle vilk√•r    12/13  23.6. Skadeoppgj√∏r  \n23.6.1.  Frist for √• s√∏ke erstatning  \nVil sikrede s√∏ke erstatning under rettshjelpsforsikringen m√• If underrettes snarest mulig og senest ett √•r \netter at advokat er engasjert. Underretningen skal skje skriftlig og dokumentasjon m√• vedlegges. Dersom \nadvokat benyttes under den offentlige forvaltnings - behandling, regnes fristen for melding til If fra det \ntidspunkt hvor den offentlige forvaltningsbehandling er fullt utnyttet.  \n23.6.2.  Valg av advokat  \nSikrede velger selv en advokat som etter sakens art og sikredes bosted passer for oppdraget.  \n23.6.3.  Hva If dekker  \nIf dekker kostnader til advokat, registrert rettshjelper, retten, sakkyndig og vitner. Ifs ansvar er begrenset \ntil rimelige og n√∏dvendige kostnader ved tvisten. Lov 17. juni 2005 nr. 90 om mekling og rettergang i sivile \ntvister (tvisteloven)  ¬ß 6-13, ¬ß 10 -5 og kapittel 20 gjelder tilsvarende. Hva som er rimelige og n√∏dvendige \nkostnader ved tvisten, fastsatt ved tvistesakens avslutning. Ved behov, kan If be sikrede om en \nredegj√∏relse for tvisten og de p√•dratte kostnadene. Dersom tvisten avgj√∏res ved dom eller  kjennelse, \nlegger If rettens fastsettelse av rimelige og n√∏dvendige sakskostnader til grunn. Foretar If en utbetaling \nforutfor tvistesakens avslutning, inneb√¶rer ikke dette en aksept av p√•dratte kostnader. Ved tvistesakens \navslutning plikter sikrede √• til bakebetale eventuelt overskytende bel√∏p til If.  \n23.6.4.  Ifs rettigheter  ved krav om oppgj√∏r  \nVed krav om oppgj√∏r har If den samme rett som sikrede til √• f√• dokumentert hvordan advokaten har \nberegnet sitt sal√¶r. Medg√•tt tid skal spesifiseres.  \nSp√∏rsm√•l om utgiftene s rimelighet kan forelegges Den Norske Advokatforening.', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 11}), Document(page_content='Generelle vilk√•r    13/13   \n \n \n  \nIf P&C Insurance Ltd (publ), represented by its \nNorwegian branch If Skadeforsikring NUF  \nThe Norwegian company register,  \nreg.no.: 981 290 666  \nP.O. Box 240, NO -1326 Lysaker, Norway  \nOffice: Drammensveien 264,  \nNO-0283 Oslo, Norway   Phone: +47 21 49 24 00  \nwww.if.no   Branch of:  \nIf P&C Insurance Ltd (publ)  \nDomicile: SE -106 80 Stockholm  \nThe Swedish Companies Registration \nOffice, reg.no.: 516401 -8102', metadata={'source': 'Generelle vilk√•r.pdf', 'page': 12})]
vector = FAISS.from_documents(documents, embeddings)

#Set retriever and create retrieval chain
retriever = vector.as_retriever()
prompt = ChatPromptTemplate.from_messages([
    MessagesPlaceholder(variable_name="chat_history"),
    ("user", "{input}"),
    ("user", "Gitt den tidligere samtalen, generer et s√∏k som gir mening i relasjon til tidligere samtale")
])
retriever_chain = create_history_aware_retriever(chat, retriever, prompt)

prompt = ChatPromptTemplate.from_messages([
    ("system", "Svar p√• brukerens sp√∏rsm√•l ved i form av en forsikringsagent med denne informasjonen:\n\n{context}"),
    MessagesPlaceholder(variable_name="chat_history"),
    ("user", "{input}"),
])

document_chain = create_stuff_documents_chain(chat, prompt)
retrieval_chain = create_retrieval_chain(retriever_chain, document_chain)

def build_message_list():
    """
    Build a list of messages including system, human and AI messages.
    """
    # Start zipped_messages with the SystemMessage
    zipped_messages = [SystemMessage(
        content="Du er en hjelpsom forsikringsagent som hjelper kunder med sp√∏rsm√•l de har rundt generelle vilk√•r i sin forsikringsavtale. Dersom du ikke vet svaret kan du henvise dem til en kundebehandler.")]

    # Zip together the past and generated messages
    for human_msg, ai_msg in zip_longest(st.session_state['past'], st.session_state['generated']):
        if human_msg is not None:
            zipped_messages.append(HumanMessage(
                content=human_msg))  # Add user messages
        if ai_msg is not None:
            zipped_messages.append(
                AIMessage(content=ai_msg))  # Add AI messages

    return zipped_messages


def generate_response(user_input):
    """
    Generate AI response using the ChatOpenAI model.
    """
    # Build the list of messages
    zipped_messages = build_message_list()
    output = retrieval_chain.invoke({"chat_history":zipped_messages,"input":user_input})
    # Generate response using the chat model
    return output['answer']


# Define function to submit user input
def submit():
    # Set entered_prompt to the current value of prompt_input
    st.session_state.entered_prompt = st.session_state.prompt_input
    # Clear prompt_input
    st.session_state.prompt_input = ""


# Create a text input for user
st.text_input('YOU: ', key='prompt_input', on_change=submit)


if st.session_state.entered_prompt != "":
    # Get user query
    user_query = st.session_state.entered_prompt

    # Generate response
    output = generate_response(user_query)

    # Append user query to past queries
    st.session_state.past.append(user_query)

    # Append AI response to generated responses
    st.session_state.generated.append(output)

# Display the chat history
if st.session_state['generated']:
    for i in range(len(st.session_state['generated'])-1, -1, -1):
        # Display AI response
        message(st.session_state["generated"][i], key=str(i))
        # Display user message
        message(st.session_state['past'][i],
                is_user=True, key=str(i) + '_user')


# Add credit
st.markdown("""
---
Laget med ü§ñ av Harald Osan""")
