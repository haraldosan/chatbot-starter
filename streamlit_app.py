# Import required libraries
from itertools import zip_longest
import streamlit as st
from langchain_community.document_loaders import PyPDFLoader
from streamlit_chat import message
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import FAISS
from langchain.schema import (
    SystemMessage,
    HumanMessage,
    AIMessage
)
import os
from langchain_community.document_loaders import PyPDFLoader
from langchain_community.vectorstores import FAISS
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_openai import OpenAIEmbeddings
from langchain.chains import create_history_aware_retriever
from langchain_core.prompts import MessagesPlaceholder
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain.chains import create_retrieval_chain
from langchain_community.document_loaders import WebBaseLoader
from langchain_core.documents import Document

#Load environment variables
# Set streamlit page configuration
st.set_page_config(page_title="AI-Kurs ChatBot")
st.title("AI-Kurs ChatBot")

# Initialize session state variables
if 'generated' not in st.session_state:
    st.session_state['generated'] = []  # Store AI generated responses

if 'past' not in st.session_state:
    st.session_state['past'] = []  # Store past user inputs

if 'entered_prompt' not in st.session_state:
    st.session_state['entered_prompt'] = ""  # Store the latest user input

# Initialize the ChatOpenAI model
chat = ChatOpenAI(
    temperature=0.1,
    model_name="gpt-4-turbo",
    api_key=st.secrets['openai_api_key']
)
# Intialize embeddings
embeddings = OpenAIEmbeddings(openai_api_key=st.secrets['openai_api_key'])

#Fetch and load documents
#path = "app/static/CV.pdf"
#loader = PyPDFLoader(path)
#docs = loader.load()

#Indexing
text_splitter = RecursiveCharacterTextSplitter()
#documents = text_splitter.split_documents(docs)
documents = [Document(page_content='Generelle vilkår    1/13  \n \nInnhold  \n1. Varighet for forsikringsavtalen og beregning av premie  ................................ ................................ ................................ ...........  3 \n2. Fornyelse av fo rsikringen  ................................ ................................ ................................ ................................ ................................ ............  3 \n3. Oppsigelse i forsikringstiden – Sikrede  ................................ ................................ ................................ ................................ ..............  3 \n4. Oppsigelse i forsikringstiden – If ................................ ................................ ................................ ................................ ............................  4 \n5. Skjønn  ................................ ................................ ................................ ................................ ................................ ................................ .....................  5 \n6. Renter av erstatningsbeløp  ................................ ................................ ................................ ................................ ................................ ....... 5 \n7. Merverdiavgift  ................................ ................................ ................................ ................................ ................................ ................................ ... 5 \n8. Mangelfull/fe ilaktig utført reparasjon  ................................ ................................ ................................ ................................ .................  5 \n9. Følgene av svik  ................................ ................................ ................................ ................................ ................................ ................................ .. 6 \n10. Identifikasjon  ................................ ................................ ................................ ................................ ................................ ................................ ... 6 \n11. Ulovlige interesser  ................................ ................................ ................................ ................................ ................................ .........................  6 \n12. Ikke d eklarerte gjenstander  ................................ ................................ ................................ ................................ ................................ .... 6 \n13. Vinningsforbud  ................................ ................................ ................................ ................................ ................................ ...............................  6 \n14. Lovvalg  ................................ ................................ ................................ ................................ ................................ ................................ .................  6 \n15. Valuta  ................................ ................................ ................................ ................................ ................................ ................................ ...................  6 \n16. Garantiordning for skadeforsikring  ................................ ................................ ................................ ................................ ....................  7 \n17. Særlige begrensninger i Ifs erstatningsplikt  ................................ ................................ ................................ ................................ ... 7 \n18. Verneting  ................................ ................................ ................................ ................................ ................................ ................................ ...........  9', metadata={'source': 'Generelle vilkår.pdf', 'page': 0}), Document(page_content='19. Personopplysninger  ................................ ................................ ................................ ................................ ................................ .....................  9 Generelle vilkår  \nForsikringsvilkår GEN 2-9 \nGjelder fra 10. juni  2023', metadata={'source': 'Generelle vilkår.pdf', 'page': 0}), Document(page_content='Generelle vilkår    2/13  20. Trafikkforsikringsavgift til staten  ................................ ................................ ................................ ................................ ........................  9 \n21. EUs klageportal  ................................ ................................ ................................ ................................ ................................ ...............................  9 \n22. Rettshjelp - generelle bestemmelser  ................................ ................................ ................................ ................................ ...............  10', metadata={'source': 'Generelle vilkår.pdf', 'page': 1}), Document(page_content='Generelle vilkår    3/13  Disse vilkår gjelder i den utstrekning de ikke er fraveket i de enkelte bransjevilkår eller i forsikringsbeviset.  \n1. Varighet for forsikringsavtalen og beregning av premie  \nForsikringen gjelder fra det tidspunkt avtale er vedtatt av partene eller fra og med en senere avtalt dato kl. \n00.00. Forsikringen gjelder til kl. 24.00 siste dato i avtaleperioden. Tilsvarende gjelder for senere \nfornyelser.  \nHvis det er en forutsetning at premien skal være betalt før Ifs ansvar begynner å løpe, kommer  dette frem \nav forsikringsbeviset for den enkelte dekning.  \nOpphører en løpende forsikring i avtaleperioden, har If krav på premie forholdsmessig etter den tiden \nforsikringen har vært i kraft, med mindre noe annet kommer frem  av det enkelte fo rsikringsvilkår.  \nVed terminvis premiebetaling vil det kunne bli beregnet et termintillegg.  \n2. Fornyelse av forsikringen  \nForsikring som gjelder for en tid av minst ett år, fornyes for ett år a v gangen, hvis ikke forsikringstakeren \nhar sagt opp avtalen innen fo rsikringstidens utløp.  \n3. Oppsigelse i forsikringstiden – Sikrede   \n3.1. Sikrede kan si opp  \n3.1.1. Livsforsikring  \n• Når som helst i forsikringsåret.  \nDette punkt kan være fraveket i avtaler om kollektiv forsikring og vil i så fall komme frem  av \nforsikringsbeviset.  \n3.1.2. Annen personforsikring  \n• Når som helst med 1 måneds varsel,  jf. lov 16. juni 1989 nr. 69 om forsikringsavtaler  \n(forsikringsavtaleloven – FAL ) § 12-3, 3. ledd dersom behovet faller bort eller ved andre særlige \ngrunner kan forsikringen sies opp umiddelbart. Dette punkt kan være fraveket i avtaler om kollektiv \nforsikring og vil i så fall komme frem  av forsikringsbeviset.  \n3.1.3. Skadeforsikring  \n• Dersom for sikringsbehovet faller bort eller det foreligger andre særlige grunner, jf. F AL § 3-6, 1.ledd.  \n• For flytting til et annet forsikringsselskap med 1 måneds varsel. Varselet skal inneholde opplysning om \ndato for flyttingen og til hvilket selskap den skal flyt tes til, jf. FAL § 3 -6, 2. ledd, 2. punktum.  \nFor at oppsigelsen skal komme inn under reglene om flytting, skal den nye forsikringen ha minst samme \neller tilnærmet samme dekningsomfang.  \nFor kollektive forsikringsavtaler og forsikringsavtaler for virksomhet er som kommer inn under FAL § 1 -3 \npunkt a til e, kan retten til flytting fravikes. Dette vil i så fall komme frem  av forsikringsbeviset.', metadata={'source': 'Generelle vilkår.pdf', 'page': 2}), Document(page_content='Generelle vilkår    4/13  4. Oppsigelse i forsikringstiden  – If \nFor If er oppsigelsestiden 2 måneder før utløpet av forsikringstiden. Forsikringsvilkår og premie kan \nendres og blir gjeldende fra fornyelsesdag.  \n4.1. If kan si opp forsikringen  \n4.1.1. Med øyeblikkelig virkning  \nHvis det foreligger svik i forbindelse m ed opplysninger om risikoen, jf. FAL § 4 -3 eller § 13 -3. \n4.1.2. Med en ukes varsel  \nHvis det foreligger svik ved skadeoppgjøret, jf. FAL § 8 -1 eller §18 -1. \n4.1.3. Med 14 dagers varsel  \nHvis det er gitt uriktige eller ufullstendige opplysninger om risikoen, jf. FAL § 4 -3 eller § 13 -3. \n4.1.4. Med to måneders varsel  \nJf. FAL § 3 -7 eller § 12 -4 hvis d et er rimelig og  \n• forsikringstaker/sikrede/forsikrede har fremkalt - eller har medvirket til å fremkalle - skade forsettlig, \neller  \n• sikrede har forsømt å overholde en sikkerhetsforskrift, eller  \n• skadeforløpet viser stort avvik fra det normale, eller  \n• det i løpet av de siste 12 måneder har vært minst 3 skader tilsammen under denne og andre avtaler \nmed If , eller  \n• forsikringstaker/sikrede/forsikrede har medvirket til svik mot If i henhold til FAL § 4 -3 eller § 13 -2 eller \n§ 8-1/18 -1, eller  \n• forsikringstaker gjentatte ganger har misligholdt betalingsfristene , eller  \n• forsikringstaker/sikrede/forsikrede eller noen som kan identifiseres med disse, har fremsatt trusler \nmot ansatte i If , eller  \n• forsikringstaker/sikrede/ forsikrede har begått et straffbart forhold mot If, eller  \n• If ikke får gjennomført løpende oppfølging av kundeforholdet i samsvar med pliktene som følger av \nhvitvaskingsloven.  \n4.1.5. Med 2 måneders frist  \nJf. FAL §. 3 -7 eller § 12 -4 der bruken av forsikringsgjenstanden eller sikredes virksomhet endres  i \nforsikri ngstiden på en måte som:  \n• Innebærer at If ikke ville ha overtatt forsikringen om det nye forholdet hadde foreligget ved \nforsikringstidens begynnelse, eller  \n• Er av betydning for Selskapets mulighet til å gjenforsikre.  \n4.2. Ved manglende betaling  \nDers om forsikringen opphører på grunn av manglende betaling har If krav på premie for den tid det har \nvært i ansvar etter bestemmelsene i FAL kapittel 5 og/eller kapittel 14.', metadata={'source': 'Generelle vilkår.pdf', 'page': 3}), Document(page_content='Generelle vilkår    5/13  If har også krav på et tillegg for følgende omkostninger:  \nPoliseutstedelseskostnad innti l 300 kroner per avtale, og panthaverinteresse inntil 300 kroner per \nforsikringsobjekt, dog 600 kroner for fritidsbåt.  \n5. Skjønn  \nEr det adgang til å kreve skjønn i henhold til forsikringsvilkårene, gjelder følgende bestemmelser om \nfremgangsmåten:  \nSkjønn kan kreves når som helst under skadeoppgjøret.  \nSkjønn avgis av sakkyndige og uhildede personer. Hver av partene velger en skjønnsmann. Hvis noen av \npartene ønsker det, kan han eller hun velge særskilt skjønnsmann for bestemte ting og ved avbruddstap \nfor bestem te spørsmål.  \nHar den ene av partene skriftlig underrettet den annen om sitt valg, plikter denne innen en uke etter at \nhan eller hun har mottatt underretningen å gi meddelelse om hvem han eller hun velger. Før skjønnet \nvelger de to skjønnsmenn en oppmann.  \nHvis noen av partene forlanger det, skal denne være bosatt utenfor partenes hjemsted og utenfor den \nkommune hvor forsikringstilfellet er inntruffet. Unnlater en av partene å velge skjønnsmann, oppnevnes \ndenne på hans eller hennes vegne av tingretten i den rettskrets hvor skjønnet foretas. Blir \nskjønnsmennene ikke enige om oppmann, oppnevnes denne på samme måte.  \nSkjønnsmennene plikter å innhente de opplysninger og foreta de undersøkelser som de anser nødvendige. \nDe plikter å avgi sitt skjønn på grunnlag av f orsikringsvilkårene. De to skjønnsmenn foretar verdsettelsen \nog besvarer spørsmålene ved avbruddstap, uten at oppmannen tilkalles. Blir de ikke enige, tilkalles \noppmannen, som etter de samme regler avgir sitt skjønn over de punkter som skjønnsmennene er ue nige \nom. Blir oppmannen tilkalt, beregnes erstatningen på grunnlag av dennes skjønn. Erstatning skal dog ikke \nligge utenfor de grenser som de to skjønnsmenns ansettelser vil medføre.  \nPartene betaler hver sin skjønnsmann. Honorar til oppmannen og mulige an dre omkostninger ved skjønnet \nbæres av partene med en halvdel hver. Er det Selskapet som krever skjønn ved tingskade, og  den annen \npart er forsikringstaker i egenskap av privatperson,  dekker Selskapet likevel alle omkostninger ved - \nskjønnet hvis forsikring stakeren ikke selv ønsker å bære sin del. Skjønnets verdsettelser er bindende for \nbegge parter.  \n6. Renter av erstatningsbeløp  \nSikrede har krav på renter overensstemmende med reglene i FAL § 8-4 eller § 18 -4. \n7. Merverdiavgift  \nIf erstatter ikke merverdiavgift som sikrede har fradragsrett for i sin næringsvirksomhet.  \n8. Mangelfull/feilaktig utført reparasjon  \nIf svarer ikke for mangelfull/feilaktig utført reparasjon, eller følgeskader etter slik reparasjon, med mindre \nde nye skadene er dekningsmessige  i henhold til forsikringens vilkår.', metadata={'source': 'Generelle vilkår.pdf', 'page': 4}), Document(page_content='Generelle vilkår    6/13  9. Følgene av svik  \nDen som gjør seg skyldig i svik mot If, mister ethvert erstatningskrav mot If etter denne og andre \nforsikringsavtaler i anledning samme hendelse. Allerede utbetalte erstatningsbeløp kan kreves \ntilbakebet alt. If kan si opp enhver forsikringsavtale med sikrede, jf. FAL § § 4-2, 4-3 og 8-1 eller § 13 -2, 13 -3 \nog 18 -1, jf. også punkt 4.1 og 10. \nIf kan også si opp enhver forsikringsavtale med den som medvirker til svik, jf. også punkt 4.1.4 ovenfor.  \n10. Identifikasjon  \nBestemmelser om at sikredes rett til erstatning helt eller delvis bortfaller som følge av sikredes handlinger \neller unnlatelser får tilsvarende anvendelse ved handlinger eller unnlatelser fra personer som nevnt i FAL \n§ 4-11, annet ledd.  \nFor næringsforsikring gjelder i tillegg følgende:  \nDe handlinger eller unnlatelser som medfører bortfall eller reduksjon av sikredes rett til erstatning \nmedfører tilsvarende bortfall eller reduksjon dersom de er begått av personer som utfører arbeid av \nledende art eller av andre som har selvstendig stilling innen virksomheten. Med personer som har særlig \nselvstendig stilling menes også personer som utfører arbeidsoppdrag uten overoppsyn fra andre, eller som \nutfører arbeidsoppdrag de selv er ansvarlige for. Sikre de identifiseres tilsvarende med sine \nkontraktsmedhjelperes handlinger eller unnlatelser.  \n11. Ulovlige interesser  \nForsikringen omfatter kun lovlige interesser som kan verdsettes i penger.  \n12. Ikke deklarerte gjenstander  \nForsikringen omfatter ikke erstatning for gj enstander som er kjøpt, eller mottatt som gave, utenfor Norge \nog som ikke er deklarert ved innførsel i henhold til gjeldende regelverk. Se lov 21. desember 2007 nr. 119 \nom toll og vareførsel (tolloven) og lov 19. juni 2009 nr. 58 om merverdiavgift (merverd iavgiftsloven) med \nforskrifter.  \n13. Vinningsforbud  \nForsikringen skal ikke føre til vinning, men skal bare erstatte det tap som virkelig er lidt innenfor rammen \nav forsikringsavtalen. Forsikringssummen er intet bevis for tingens eller interessens verdi.  \n14. Lovvalg  \nNorsk lovgivning gjelder for forsikringsavtalen i den utstrekning dette ikke er i strid med lov 27. november \n1992 nr. 111 om lovvalg i forsikring (forsikringslovvalgsloven) , eller det er gjort annen avtale.  \n15. Valuta  \nPremiebeløp, forsikringssummer, erstatningsbeløp med videre som springer ut av forsikringsavtalen, \nregnes i norske kroner (NOK) dersom ikke annet kommer frem  av vilkår eller forsikringsbevis.', metadata={'source': 'Generelle vilkår.pdf', 'page': 5}), Document(page_content='Generelle vilkår    7/13  16. Garantiordning for skadeforsikring  \nIf er medlem av garantiordningen for skadeforsikring, se lov av 10. april 2015 nr. 17 kap. 2 0A om \nfinansforetak og finanskonsern (finansforetaksloven) . Ordningen skal være en trygghet for sikrede dersom \nIf blir insolvent og  ikke kan betale det de plikter i  henhold til inngåtte skadeforsikringsavtaler.  \nGarantiordningen dekker opptil 90 % av hvert enkelt krav. Krav etter forsikringer som gjelder bolig og \ntvungen ansvarsforsikring skal likevel dekkes med 100 %. Garantiordningen dekker ikke forsikringskrav \nutov er 20 millioner kroner for hvert krav for hver sikret for hvert skadetilfelle.  Garantiordningen dekker \nkun krav vedrørende risikoer som består her i riket, jf. finansforetaksforskriften § 20A -1 annet ledd.  \nGarantiordningen dekker blant annet ikke kredittfo rsikring, livsforsikringer, energiforsikringer og \nluftfartsforsikringer. Videre dekkes ikke sjøforsikring, unntatt når forsikringen gjelder skip som ikke er \nregistreringspliktige i henhold til lov 24. juni 1994 nr. 39 om sjøfarten (sjøloven)  § 11 annet led d, eller \nfiskefartøyer opp til og med 50 bruttotonn som er registrert i Skipsregisteret, jf. sjøloven § 11 første ledd \nførste punktum.  \nGarantiordningen dekker ikke næringslivsforsikringer, når forsikringen gjelder foretak som ved \navtaleinngåelsen eller sen ere fornyelser oppfyller minst to av følgende vilkår : \n• Har flere enn 250 ansatte  \n• har en omsetning på minst 100 millioner kroner ifølge siste årsoppgjør  \n• har eiendeler ifølge siste balanse på minst 50 millioner kroner.  \nGarantiordningen dekker likevel ansvars forsikringer som er pålagt etter norsk lov (tvungen \nansvarsforsikring).  \nFor nærmere detaljer henvises det til finansforetaksloven kap. 20A .  \n17. Særlige begrensninger i Ifs erstatningsplikt  \n17.1. Kjernefysisk, biologisk, kjemisk og radioakti v skadeårsak  \nIf svarer ik ke for tap eller skade, og økning i tap eller skade, som direkte eller indirekte er forårsaket av \neller står i sammenheng med  \n• ioniserende stråling eller radioaktiv forurensning fra kjernefysisk brensel eller atomavfall fra \nforbrenning av kjernefysisk brensel,  \n• radioaktive, giftige, eksplosive eller andre farlige egenskaper ved enhver eksplosiv kjernefysisk enhet \neller kjernefysiske komponenter i disse,  \n• ethvert våpen eller annen anordning der det benyttes atomspalting, kjernespalting og/elle r \nkjernefysisk fusjon eller atomfusjon, eller andre lignende reaksjoner eller radioaktiv kraft eller \nradioaktivt materiale,  \n• radioaktive, giftige, eksplosive eller andre farlige eller forurensende egenskaper ved radioaktivt \nmateriale. Unntaket i dette kule punktet  omfatter ikke radioaktive isotoper, annet enn kjernefysisk \nbrensel, når disse isotopene blir fremstilt, transportert, lagret eller brukt til kommersielle, \nlandbruksrelaterte, medisinske eller vitenskapelige formål eller andre lignende fredelige form ål, eller  \n• kjemiske, biologiske, biokjemiske eller elektromagnetiske våpen . \nPunktene ovenfor gjelder uavhengig av enhver annen årsak eller hendelse som bidrar samtidig eller i \nrekkefølge til skaden.', metadata={'source': 'Generelle vilkår.pdf', 'page': 6}), Document(page_content='Generelle vilkår    8/13  17.2. Krig , streik, opptøyer og sivile uroligheter  \nIf svarer ikk e for tap eller skade, og/eller økning i tap eller skade, som direkte eller indirekte er forårsaket \nav eller står i sammenheng med krig, invasjon, handlinger fra en fremmed fiendtlig makt, fiendtligheter \neller krigslignende operasjoner (uavhengig av om det  er erklært krig eller ikke), borgerkrig, mytteri, \nopprør, streik, opptøyer, sivile uroligheter av et omfang som tilsvarer en folkelig eller militær makt, \nrevolusjon, opprør eller militær eller annen tilraning av makten. Alt dette uavhengig av enhver annen  årsak \neller hendelse som bidrar samtidig eller i rekkefølge til skaden.  \n17.3. Terror  \nFor forsikringer av bygninger, maskiner, løsøre, varer og driftstap knyttet til næringsvirksomhet, offentlig \nvirksomhet og bygninger/husleietap tilhørende borettslag/boligsameie er erstatningsplikten begrenset til \nEUR 50 000 000 per hendelse, dersom den erstatningsmessige skade er forårsaket av eller står i \nsammenheng med en terrorhandling. For slike forsikrede ting og interesser som befinner seg utenfor \nNorden, Estland, Latvia eller Litauen, erstattes ikke skader som er forårsaket av eller står i sammenheng \nmed terrorhandling.  \nMed terrorhandling forstås en rettsstridig, skadevoldende handling rettet mot allmennheten, herunder en \nvoldshandling eller farlig sp redning av biologiske eller kjemiske substanser - og som fremstår å være utført \ni den hensikt å utøve innflytelse på politiske, religiøse eller andre ideologiske organer eller for å fremkalle \nfrykt. Med hendelse forstås alle skader som rammer If og dets mo rselskap med øvrige filialers \nforsikringstakere i Norden, Estland, Latvia eller Litauen innenfor et tidsrom av 48 timer. Overstiges den \nfastsatte grense pr hendelse, må sikrede tåle en forholdsmessig reduksjon av erstatningsbeløpet.  \nSkader forårsaket av el ler som står i sammenheng med terror ved bruk av, eller trusler om bruk av \natomvåpen eller farlig spredning av biologiske eller kjemiske substanser er uansett ikke dekket.  \nDenne begrensning gjelder i den utstrekning det ikke uttrykkelig er presisert i fors ikringsbeviset eller i \npersonforsikrings eller reiseforsikrings bransjevilkår, at den er fraveket helt eller delvis.  \n17.4. Jordskjelv og vulkanske utbrudd  \nIf svarer ikke for tap eller skade, og økning i tap eller skade, som direkte eller indirekte er forårsaket av \neller står i sammenheng med jordskjelv og vulkanske utbrudd.  \nDenne begrensning gjelder i den utstrekning det ikke uttrykkelig er presisert i bransjevilkåret at den er \nfraveket.  \n17.5. Brudd på internasjonal lovgivning, sanksjoner  \nIf kan ikke gi tilsagn om dekn ing eller betale ut erstatning eller andre ytelser dersom dette kan medføre at \nIf handler i strid med, eller utsetter If for forbud, restriksjoner eller sanksjoner vedtatt i De Forente \nNasjoners organer. Det samme gjelder handels - eller økonomiske sanksj oner, nedfelt i lover eller direktiver \nvedtatt av EU, USA eller Norge.  \n17.6. Unntak som gjelder Russland -relaterte risikoer  \nForsikringen dekker ikke  \n• transport av varer til, fra, innen eller gjennom Den russiske føderasjon, Belarus, Donetsk, Luhansk, \nKrim -territor iet eller  Den russiske føderasjons territorialfarvann.  \n• skader eller erstatningskrav i forbindelse med transport av varer til, fra, innen eller gjennom Den \nrussiske føderasjon, Belarus, Donetsk, Luhansk, Krim -territoriet eller Den russiske føderasjons \nterritorialfarvann.  \n• eiendom, eller skade på eiendom, uanset t art, som direkte eller indirekte er kjøpt eller importert fra \nDen russiske føderasjon  etter 31. desember 2022 .', metadata={'source': 'Generelle vilkår.pdf', 'page': 7}), Document(page_content='Generelle vilkår    9/13  18. Verneting  \nTvister etter forsikringsavtalen avgjøres ved norsk domstol, med mindre det er i strid med ufravikelige \nregler i gjeldende lovgivning , eller det er gjort annen avtale.  \n19. Personopplysninger  \nIf behandler personop plysninger i overensstemmelse med gjeldende lovgivning om forsikring og \ndatabeskyttelse. Les mer om behandling av personopplysninger på vår hjemmeside: \nhttp://www.if.no/personopplys ninger.   \n20. Trafikkforsikringsavgift til staten  \nIf krever inn trafikkforsikringsavgift til staten og avgiften må betales for alle registrerte kjøretøy under 7 \n500 kg. Betaling av avgift er en forutsetning for forsikringsavtalen . Dersom avgift ikke betales for slikt \nforsikret kjøretøy , får dette samme virkning for forsikringene under samme forsikringsavtale som \nmanglende betaling av forsikringspremie.  \n21. EUs klageportal  \nEUs klageportal kan benyttes i saker som gjelder kjøp av tjeneste r og varer på nett. (Klageportalen er \nopprettet primært for grenseoverskridende saker der partene er i ulike land, men utelukker ikke at \nnasjonale saker kan inngis). Lenke til portalen finner du på våre hjemmesider www.if.n o under overskriften \n«Klagemuligheter». I klageportalens skjema blir du bedt om å fylle inn Ifs e -postadresse, bruk da: \nkundeombudet@if.no . \n22. Generelle fravikelser fra FAL for store risikoer \n(Forsikringsavtaleforskri ften)  og andre enn forbrukere (FAL \n§ 1-2a) \n22.1. Kommunikasjon – FAL §1 -6 \nFølgende fravikelser er avtalt for «store risikoer» og andre enn forbrukere:  \nEn elektronisk melding fra foretaket skal anses mottatt og ha kommet til mottakers kunnskap på det \ntidspunkt meldingen er sendt til mottakers avtalte kommunikasjonsplattform. § 1 -6 annet og tredje ledd er \nmed dette fraveket.  \nFor «store risikoer» er i tillegg følgende fravikelser avtalt:  \nAll kommunikasjon mellom partene kan foregå ved elektronisk kommuni kasjon. Kunden kan ikke reservere \nseg mot denne kommunikasjonsformen. Kommunikasjonen foregår gjennom avtalte \nkommunikasjonsplattformer. § 1 -6 første ledd er fraveket. Når det etter forsikringsavtaleloven stilles krav \nom at noen skal varsles, er lovens kra v oppfylt ved at varselet avsendes til avtalt \nkommunikasjonsplattform. § 1 -6 fjerde ledd er fraveket. Med skriftlig dokument menes papir eller enhver \nelektronisk kommunikasjon som er sendt til mottakers avtalte kommunikasjonsplattform. § 1 -6 femte ledd \ner fraveket.', metadata={'source': 'Generelle vilkår.pdf', 'page': 8}), Document(page_content='Generelle vilkår    10/13  22.2. Prekontraktuelle plikter – FALs annen del  \nFølgende fravikelser er avtalt for «store risikoer» og andre enn forbrukere:  \n§ 1C -3 er fraveket, ved at foretaket ikke plikter å gi standardisert informasjonsdokument til kunden.  \nFor «store risikoer» er i  tillegg følgende fravikelser avtalt:  \nLovens annen del gjelder ikke for forsikringsdistribusjon knyttet til avtale om store risikoer. §1A -1 første og \nannet ledd er fraveket.  \n§ 1B -1 er fraveket ved at kunden identifiserer sine krav og behov før inngåelse av  forsikringsavtalen, og \nsørger for at disse oppfylles gjennom  avtalen. Dette gjelder videre i forhold til alle øvrige prekontraktuelle \nplikter i §1B -1, også i forhold til alternative dekningsformer og aktuelle  tilleggsdekninger, og gjelder både \nved skade - og personforsikring. Det er ikke krav om bruk av skriftlig dokument, verken knyttet til \nanbefalinger eller ved fremsettelse av tilbud. Forsikringsdistributør kan kreve vederlag for oppfyllelse av \nopplysnings - eller varslingsplikter etter forsikringsavtalel oven.  \nKapittel 1C er fraveket i sin helhet. Kundens informasjonsbehov anses avdekket og oppfylt fortløpende og i \nnødvendig utstrekning i de løpende forhandlinger og i kommunikasjonen mellom forsikringsdistributøren \nog kunden forut for avtaleinngåelsen. Kun den har det endelige ansvaret for å etterspørre informasjon \nkunden mener er relevant før avtaleinngåelsen.  \n22.3. Bevisbyrde (§ 21 -1) /erstatning for pliktbrudd (  § 21 -2)/klageregler (§ \n22-1) \nFølgende fravikelser er avtalt for «store risikoer» og andre enn forbr ukere:  \nDet er alminnelige bevisbyrderegler som gjelder for spørsmålet om forsikringsforetaket har oppfylt sine \nplikter etter lov og forskrift. § 21 -1 er fraveket.  \nForsikringsforetakets erstatningsplikt er begrenset til den positive kontraktsinteresse, dvs . den \nforsikringsutbetaling kunden hadde hatt krav på hvis forsikringsforetaket hadde oppfylt sine plikter etter \n§ 1-5 første ledd. § 21 -2 er fraveket.  \nKlager og krav som gjelder brudd på § 1 -5 første ledd, besvares av forsikringsforetaket innenfor rammen \nav foretakets alminnelige saksbehandlingstid. Det gjelder ingen formkrav eller særskilte frister for \nbesvarelsen. § 22 -1 tredje ledd er fraveket.  \n23. Rettshjelp - generelle bestemmelser  \nNår det av bransjevilkåret kommer frem at rettshjelp er omfattet av forsikringsavtalen og det er henvist til \ndette punkt et, gjelder disse generelle bestemmelser.  \n23.1. Hva forstås med "tvist"  \nMed tvist forstås at et krav er fremsatt og bestridt, helt eller delvis. Vedvarende taushet hos motpart vil \nkunne anses som tvist. Det kan  være én tvist selv om saken består av flere spørsmål og de faktiske og \nrettslige tvistegrunnlag er ulike. Det er én tvist selv som spørsmålene fremmes i flere saker. Det samme \ngjelder selv om det er flere parter på samme side, og også om partene har forsk jellige forsikringsavtaler i \nforskjellige forsikringsselskap.  \n23.2. Hva If dekker  \nForsikringen dekker utgifter - saksomkostninger -ved tvist oppstått i forsikringstiden, og hvor tvisten \nhører inn under de alminnelige domstoler, jf.  lov 13. august 1915 nr. 5 om d omstolene ( domstolloven ) § 1. \nUtgifter til sakkyndige som ikke er oppnevnt av retten, dekkes bare når utgiftene på forhånd er godkjent \nav If. Utgifter til vitner dekkes bare ved hovedforhandling og bevisopptak. Idømte saksomkostninger \ndekkes ikke. Saksomko stninger som dekkes av motpart, går til fradrag. Likevel dekkes slike \nsaksomkostninger når sikrede kan godtgjøre at motparten ikke er søkegod.', metadata={'source': 'Generelle vilkår.pdf', 'page': 9}), Document(page_content='Generelle vilkår    11/13  23.3. Forsikringssum  \nDen samlede erstatning ved hver tvist er begrenset til 100  000 kroner. I de tilfeller det er tre eller flere \nparter på sikredes side og de faktiske og juridiske problemstillinger i det alt vesentlige er de samme er den \nsamlede forsikringssummen begrenset t il 250  000 kroner.  \nI saker mot selger av bolig og/eller selgers boligselgerforsikringsselskap er timesatsen som dekkes \nbegrenset til gjeldende offentlige salærsatser med tillegg av 200 kroner, jf. forskrift 3. desember 1997 nr. \n1441 om salær fra det offen tlige til advokater m.v. ( salærforskriften ) § 2. If svarer ikke for evt. kostnader \nsom oppstår ved bytte av advokat.  \nAnnen forsikringssum kan være angitt i bransjevilkåret og gjelder da foran ovennevnte forsikringssummer.  \n23.4. Egenandel  \nEgenandel 4  000 kroner m ed tillegg av 20% av det overskytende. Det trekkes bare en egenandel for hver \ntvist selv om det er flere parter på samme side. Annen egenandel kan være angitt i bransjevilkåret og \ngjelder da foran ovennevnte egenandel.  \n23.5. Utgifter If ikke dekker  \nIf dekker ikk e utgifter ved:  \n1: Tvist dersom tvistegrunnlaget forelå ved forsikringens ikrafttreden.  \n2: Tvist som har sammenheng med eller sitt utspring i separasjon, skilsmisse, barnefordeling, \nsamværsrett, farskap, arv, krav om omstøtelse av gave, underholdsbidrag, bodelin g, økonomisk \nfellesskap etablert av samboende og oppløsning av husstandsfellesskap samt skiftesaker.  \n3: Tvist som har sammenheng med eller sitt utspring i sikredes yrke eller erverv herunder oppgjør etter \nyrkesskadeforsikringsloven.  \nVed tvist om erstatning et ter lov 16. juni 1989 nr. 65 om yrkesskadeforsikring \n(yrkesskadeforsikringsloven)  dekkes likevel utgifter påløpt etter at sak er anlagt for de alminnelige \ndomstoler. Med erverv forstås enhver virksomhet som har som formål å tjene penger.  \n4: Tvist som alene gj elder tvangsfullbyrdelse.  \n5: Tvist som gjelder gjeldsforhandling/gjeldsordningssak og sak som gjelder konkurs - eller \nakkordforhandling dersom sikrede er konkurs - eller akkordskyldner.  \n6: Ved tvist som gjelder eller som har sitt utspring i straffbar handling, ære krenkelsessak, \nførerkortbeslag eller erstatningskrav i slike saker når sikrede er part, mistenkt, siktet eller tiltalt. \nLikevel dekkes utgifter dersom sikrede er fornærmet/skadelidt i anledning straffbar handling.  \n7: Tvist som gjelder offentlig forvaltningsve dtak. Likevel dekkes utgifter ved søksmål når den \nadministrative klagemulighet er fullt utnyttet. I tilknytning til søksmål er enhver utgift pådratt under \nforvaltningsbehandlingen unntatt fra dekning. Utlendingssaker vil i sin helhet være unntatt fra \ndekni ngen.  \n8: Tvist om advokatsalær eller tvist om utgifter til sakkyndige.  \n9: Tvist som gjelder finansielle spareprodukter med investering over 1 000  000 kroner, og handel med \nfinansielle instrumenter.  \n10: Tvist som gjelder utleiebolig som skal regnskap slignes, når utgi ften er fradragsberettiget (skatteloven \n§6).  \n11: Tvist som åpenbart ikke kan vinne frem.  \n12: Tvist som gjelder Ifs avslag på dekning av rettshjelpsforsikring.', metadata={'source': 'Generelle vilkår.pdf', 'page': 10}), Document(page_content='Generelle vilkår    12/13  23.6. Skadeoppgjør  \n23.6.1.  Frist for å søke erstatning  \nVil sikrede søke erstatning under rettshjelpsforsikringen må If underrettes snarest mulig og senest ett år \netter at advokat er engasjert. Underretningen skal skje skriftlig og dokumentasjon må vedlegges. Dersom \nadvokat benyttes under den offentlige forvaltnings - behandling, regnes fristen for melding til If fra det \ntidspunkt hvor den offentlige forvaltningsbehandling er fullt utnyttet.  \n23.6.2.  Valg av advokat  \nSikrede velger selv en advokat som etter sakens art og sikredes bosted passer for oppdraget.  \n23.6.3.  Hva If dekker  \nIf dekker kostnader til advokat, registrert rettshjelper, retten, sakkyndig og vitner. Ifs ansvar er begrenset \ntil rimelige og nødvendige kostnader ved tvisten. Lov 17. juni 2005 nr. 90 om mekling og rettergang i sivile \ntvister (tvisteloven)  § 6-13, § 10 -5 og kapittel 20 gjelder tilsvarende. Hva som er rimelige og nødvendige \nkostnader ved tvisten, fastsatt ved tvistesakens avslutning. Ved behov, kan If be sikrede om en \nredegjørelse for tvisten og de pådratte kostnadene. Dersom tvisten avgjøres ved dom eller  kjennelse, \nlegger If rettens fastsettelse av rimelige og nødvendige sakskostnader til grunn. Foretar If en utbetaling \nforutfor tvistesakens avslutning, innebærer ikke dette en aksept av pådratte kostnader. Ved tvistesakens \navslutning plikter sikrede å til bakebetale eventuelt overskytende beløp til If.  \n23.6.4.  Ifs rettigheter  ved krav om oppgjør  \nVed krav om oppgjør har If den samme rett som sikrede til å få dokumentert hvordan advokaten har \nberegnet sitt salær. Medgått tid skal spesifiseres.  \nSpørsmål om utgiftene s rimelighet kan forelegges Den Norske Advokatforening.', metadata={'source': 'Generelle vilkår.pdf', 'page': 11}), Document(page_content='Generelle vilkår    13/13   \n \n \n  \nIf P&C Insurance Ltd (publ), represented by its \nNorwegian branch If Skadeforsikring NUF  \nThe Norwegian company register,  \nreg.no.: 981 290 666  \nP.O. Box 240, NO -1326 Lysaker, Norway  \nOffice: Drammensveien 264,  \nNO-0283 Oslo, Norway   Phone: +47 21 49 24 00  \nwww.if.no   Branch of:  \nIf P&C Insurance Ltd (publ)  \nDomicile: SE -106 80 Stockholm  \nThe Swedish Companies Registration \nOffice, reg.no.: 516401 -8102', metadata={'source': 'Generelle vilkår.pdf', 'page': 12})]
vector = FAISS.from_documents(documents, embeddings)

#Set retriever and create retrieval chain
retriever = vector.as_retriever()
prompt = ChatPromptTemplate.from_messages([
    MessagesPlaceholder(variable_name="chat_history"),
    ("user", "{input}"),
    ("user", "Gitt den tidligere samtalen, generer et søk som gir mening i relasjon til tidligere samtale")
])
retriever_chain = create_history_aware_retriever(chat, retriever, prompt)

prompt = ChatPromptTemplate.from_messages([
    ("system", "Svar på brukerens spørsmål ved i form av en forsikringsagent med denne informasjonen:\n\n{context}"),
    MessagesPlaceholder(variable_name="chat_history"),
    ("user", "{input}"),
])

document_chain = create_stuff_documents_chain(chat, prompt)
retrieval_chain = create_retrieval_chain(retriever_chain, document_chain)

def build_message_list():
    """
    Build a list of messages including system, human and AI messages.
    """
    # Start zipped_messages with the SystemMessage
    zipped_messages = [SystemMessage(
        content="Du er en hjelpsom forsikringsagent som hjelper kunder med spørsmål de har rundt generelle vilkår i sin forsikringsavtale. Dersom du ikke vet svaret kan du henvise dem til en kundebehandler.")]

    # Zip together the past and generated messages
    for human_msg, ai_msg in zip_longest(st.session_state['past'], st.session_state['generated']):
        if human_msg is not None:
            zipped_messages.append(HumanMessage(
                content=human_msg))  # Add user messages
        if ai_msg is not None:
            zipped_messages.append(
                AIMessage(content=ai_msg))  # Add AI messages

    return zipped_messages


def generate_response(user_input):
    """
    Generate AI response using the ChatOpenAI model.
    """
    # Build the list of messages
    zipped_messages = build_message_list()
    output = retrieval_chain.invoke({"chat_history":zipped_messages,"input":user_input})
    # Generate response using the chat model
    return output['answer']


# Define function to submit user input
def submit():
    # Set entered_prompt to the current value of prompt_input
    st.session_state.entered_prompt = st.session_state.prompt_input
    # Clear prompt_input
    st.session_state.prompt_input = ""


# Create a text input for user
st.text_input('YOU: ', key='prompt_input', on_change=submit)


if st.session_state.entered_prompt != "":
    # Get user query
    user_query = st.session_state.entered_prompt

    # Generate response
    output = generate_response(user_query)

    # Append user query to past queries
    st.session_state.past.append(user_query)

    # Append AI response to generated responses
    st.session_state.generated.append(output)

# Display the chat history
if st.session_state['generated']:
    for i in range(len(st.session_state['generated'])-1, -1, -1):
        # Display AI response
        message(st.session_state["generated"][i], key=str(i))
        # Display user message
        message(st.session_state['past'][i],
                is_user=True, key=str(i) + '_user')


# Add credit
st.markdown("""
---
Laget med 🤖 av Harald Osan""")
